# =============================================================================
# Notify Manager - Automation Beispiele
# Komplette Wenn-Dann Logik mit Companion App
# =============================================================================

# =============================================================================
# BEISPIEL 1: Einfache Wenn-Dann Automation (wait_for_trigger)
# Die Automation wartet auf den Button-Klick und f√ºhrt dann die Aktion aus
# =============================================================================

automation:
  - id: alarm_mit_antwort_warten
    alias: "Alarm - Warte auf Antwort"
    description: "Sendet Alarm-Benachrichtigung und wartet auf Button-Klick"
    mode: restart  # Wichtig: Bei neuem Trigger wird alte Instanz abgebrochen
    
    trigger:
      - platform: state
        entity_id: alarm_control_panel.home_alarm
        to: "triggered"
    
    action:
      # Schritt 1: Dynamische Action-IDs erstellen (vermeidet Konflikte)
      - variables:
          action_confirm: "{{ 'ALARM_CONFIRM_' ~ context.id }}"
          action_emergency: "{{ 'ALARM_EMERGENCY_' ~ context.id }}"
          action_snooze: "{{ 'ALARM_SNOOZE_' ~ context.id }}"
      
      # Schritt 2: Benachrichtigung mit Buttons senden
      - service: notify_manager.send_actionable
        data:
          title: "üö® ALARM AUSGEL√ñST!"
          message: "Bewegung erkannt um {{ now().strftime('%H:%M') }}"
          category: alarm
          priority: critical
          tag: alarm_main
          persistent: true
          sticky: true
          actions:
            - action: "{{ action_confirm }}"
              title: "‚úì Alles OK"
              icon: "sfsymbols:checkmark.shield"
            - action: "{{ action_snooze }}"
              title: "‚è∞ Sp√§ter"
              icon: "sfsymbols:clock"
            - action: "{{ action_emergency }}"
              title: "üö® Notfall!"
              destructive: true
              icon: "sfsymbols:exclamationmark.triangle"
      
      # Schritt 3: Warte auf Button-Klick (max 5 Minuten)
      - wait_for_trigger:
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_confirm }}"
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_emergency }}"
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_snooze }}"
        timeout:
          minutes: 5
        continue_on_timeout: true
      
      # Schritt 4: Wenn-Dann Logik basierend auf Button-Klick
      - choose:
          # WENN: Benutzer klickt "Alles OK"
          - conditions:
              - condition: template
                value_template: "{{ wait.trigger.event.data.action == action_confirm }}"
            sequence:
              - service: alarm_control_panel.alarm_disarm
                target:
                  entity_id: alarm_control_panel.home_alarm
              - service: notify_manager.send_notification
                data:
                  title: "‚úÖ Alarm deaktiviert"
                  message: "Alarm wurde best√§tigt und deaktiviert."
                  priority: normal
              - service: notify_manager.clear_notifications
                data:
                  tag: alarm_main
          
          # WENN: Benutzer klickt "Notfall"
          - conditions:
              - condition: template
                value_template: "{{ wait.trigger.event.data.action == action_emergency }}"
            sequence:
              - service: script.notfall_protokoll
              - service: notify_manager.send_notification
                data:
                  title: "üö® NOTFALL AKTIVIERT"
                  message: "Notfall-Protokoll wurde gestartet!"
                  priority: critical
          
          # WENN: Benutzer klickt "Sp√§ter"
          - conditions:
              - condition: template
                value_template: "{{ wait.trigger.event.data.action == action_snooze }}"
            sequence:
              - delay:
                  minutes: 5
              # Erneut erinnern
              - service: notify_manager.send_alarm_confirmation
                data:
                  title: "üîî Alarm Erinnerung"
                  message: "Der Alarm ist immer noch aktiv!"
                  template: alarm_response
        
        # SONST: Timeout erreicht (keine Antwort)
        default:
          - service: notify_manager.send_notification
            data:
              title: "‚ö†Ô∏è Keine Antwort"
              message: "Alarm-Benachrichtigung wurde nicht beantwortet!"
              priority: high


# =============================================================================
# BEISPIEL 2: T√ºrklingel mit Kamera und T√ºr-Steuerung
# =============================================================================

  - id: tuerklingel_mit_aktionen
    alias: "T√ºrklingel - Kamera und Aktionen"
    mode: single
    
    trigger:
      - platform: state
        entity_id: binary_sensor.doorbell_button
        to: "on"
    
    action:
      - variables:
          action_open: "{{ 'DOOR_OPEN_' ~ context.id }}"
          action_speak: "{{ 'DOOR_SPEAK_' ~ context.id }}"
          action_ignore: "{{ 'DOOR_IGNORE_' ~ context.id }}"
      
      # Benachrichtigung mit Kamera-Bild
      - service: notify_manager.send_with_image
        data:
          title: "üîî T√ºrklingel"
          message: "Jemand steht an der T√ºr!"
          camera_entity: camera.doorbell
          category: doorbell
          priority: high
          tag: doorbell_ring
          actions:
            - action: "{{ action_open }}"
              title: "üîì T√ºr √∂ffnen"
              authenticationRequired: true  # Face/Touch ID erforderlich
            - action: "{{ action_speak }}"
              title: "üé§ Sprechen"
            - action: "{{ action_ignore }}"
              title: "Ignorieren"
      
      # Warte auf Antwort
      - wait_for_trigger:
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_open }}"
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_speak }}"
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_ignore }}"
        timeout:
          minutes: 2
      
      - choose:
          # T√ºr √∂ffnen
          - conditions:
              - condition: template
                value_template: "{{ wait.trigger.event.data.action == action_open }}"
            sequence:
              - service: lock.unlock
                target:
                  entity_id: lock.haustuer
              - service: notify_manager.send_notification
                data:
                  title: "üîì T√ºr ge√∂ffnet"
                  message: "Die Haust√ºr wurde entriegelt."
                  priority: normal
                  tag: doorbell_ring
          
          # Sprechen (Gegensprechanlage aktivieren)
          - conditions:
              - condition: template
                value_template: "{{ wait.trigger.event.data.action == action_speak }}"
            sequence:
              - service: camera.turn_on
                target:
                  entity_id: camera.doorbell
              # Hier z.B. Intercom aktivieren
              - service: notify_manager.send_notification
                data:
                  title: "üé§ Gegensprechanlage"
                  message: "Gegensprechanlage ist aktiv."
                  priority: normal
          
          # Ignorieren
          - conditions:
              - condition: template
                value_template: "{{ wait.trigger.event.data.action == action_ignore }}"
            sequence:
              - service: notify_manager.clear_notifications
                data:
                  tag: doorbell_ring


# =============================================================================
# BEISPIEL 3: Text-Eingabe mit Verarbeitung
# =============================================================================

  - id: einkaufsliste_text_eingabe
    alias: "Einkaufsliste - Text Eingabe"
    mode: single
    
    trigger:
      - platform: time
        at: "17:00:00"
    
    condition:
      - condition: time
        weekday:
          - sat
    
    action:
      - variables:
          action_reply: "{{ 'SHOPPING_REPLY_' ~ context.id }}"
          action_skip: "{{ 'SHOPPING_SKIP_' ~ context.id }}"
      
      - service: notify_manager.send_actionable
        data:
          title: "üõí Einkaufsliste"
          message: "Was brauchst du noch vom Supermarkt?"
          category: info
          priority: normal
          tag: shopping_list
          actions:
            - action: "{{ action_reply }}"
              title: "üìù Hinzuf√ºgen"
              behavior: textInput
              textInputButtonTitle: "Speichern"
              textInputPlaceholder: "z.B. Milch, Brot, Eier..."
            - action: "{{ action_skip }}"
              title: "√úberspringen"
      
      - wait_for_trigger:
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_reply }}"
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_skip }}"
        timeout:
          hours: 2
      
      - choose:
          # Text wurde eingegeben
          - conditions:
              - condition: template
                value_template: "{{ wait.trigger.event.data.action == action_reply }}"
            sequence:
              # Mehrere Items verarbeiten (durch Komma getrennt)
              - repeat:
                  for_each: "{{ wait.trigger.event.data.reply_text.split(',') }}"
                  sequence:
                    - service: shopping_list.add_item
                      data:
                        name: "{{ repeat.item | trim }}"
              
              - service: notify_manager.send_notification
                data:
                  title: "‚úÖ Hinzugef√ºgt"
                  message: "'{{ wait.trigger.event.data.reply_text }}' wurde zur Liste hinzugef√ºgt."
                  priority: low
                  tag: shopping_list


# =============================================================================
# BEISPIEL 4: Garagentor mit Status-Updates
# =============================================================================

  - id: garagentor_steuerung
    alias: "Garagentor - Benachrichtigung und Steuerung"
    mode: parallel
    max: 3
    
    trigger:
      - platform: state
        entity_id: cover.garage_door
        to: "open"
        for:
          minutes: 10
    
    action:
      - variables:
          action_close: "{{ 'GARAGE_CLOSE_' ~ context.id }}"
          action_keep: "{{ 'GARAGE_KEEP_' ~ context.id }}"
      
      - service: notify_manager.send_actionable
        data:
          title: "üöó Garagentor offen"
          message: "Das Garagentor ist seit 10 Minuten offen."
          category: security
          priority: high
          tag: garage_warning
          actions:
            - action: "{{ action_close }}"
              title: "Schlie√üen"
              icon: "sfsymbols:arrow.down.square"
            - action: "{{ action_keep }}"
              title: "Offen lassen"
      
      - wait_for_trigger:
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_close }}"
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_keep }}"
          # Auch reagieren wenn das Tor manuell geschlossen wird
          - platform: state
            entity_id: cover.garage_door
            to: "closed"
        timeout:
          minutes: 30
      
      - choose:
          # Button: Schlie√üen
          - conditions:
              - condition: template
                value_template: "{{ wait.trigger.event.data.action == action_close }}"
            sequence:
              - service: cover.close_cover
                target:
                  entity_id: cover.garage_door
              - wait_template: "{{ is_state('cover.garage_door', 'closed') }}"
                timeout:
                  seconds: 60
              - service: notify_manager.send_notification
                data:
                  title: "‚úÖ Garagentor geschlossen"
                  message: "Das Garagentor wurde erfolgreich geschlossen."
                  priority: normal
                  tag: garage_warning
          
          # Tor wurde manuell geschlossen
          - conditions:
              - condition: template
                value_template: "{{ wait.trigger.platform == 'state' }}"
            sequence:
              - service: notify_manager.clear_notifications
                data:
                  tag: garage_warning


# =============================================================================
# BEISPIEL 5: Einfache Catch-All Automation
# Reagiert auf ALLE Benachrichtigungsaktionen mit bestimmtem Prefix
# =============================================================================

  - id: catch_all_silence
    alias: "Catch All - Stille Aktionen"
    mode: parallel
    
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "SILENCE"
    
    action:
      # Diese Automation wird f√ºr JEDE Benachrichtigung mit SILENCE Button ausgel√∂st
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.benachrichtigungen_aktiv
      
      - delay:
          hours: 1
      
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.benachrichtigungen_aktiv


# =============================================================================
# BEISPIEL 6: URI Aktionen - Direkt zu Lovelace navigieren
# =============================================================================

  - id: bewegung_mit_kamera_link
    alias: "Bewegung - Mit Kamera-Link"
    
    trigger:
      - platform: state
        entity_id: binary_sensor.motion_garden
        to: "on"
    
    action:
      - service: notify_manager.send_actionable
        data:
          title: "üèÉ Bewegung im Garten"
          message: "Bewegung wurde erkannt."
          category: motion
          priority: high
          actions:
            # URI Action - √∂ffnet Lovelace Dashboard
            - action: "URI"
              title: "üì∑ Kameras anzeigen"
              uri: "/lovelace/cameras"
            # URI Action - √∂ffnet Entity Details
            - action: "URI"
              title: "‚ÑπÔ∏è Sensor Details"
              uri: "entityId:binary_sensor.motion_garden"
            - action: "MARK_READ"
              title: "OK"


# =============================================================================
# BEISPIEL 7: Mit action_data f√ºr zus√§tzliche Informationen
# =============================================================================

  - id: licht_steuerung_action_data
    alias: "Licht - Steuerung mit Action Data"
    
    trigger:
      - platform: state
        entity_id: binary_sensor.presence_home
        to: "off"
        for:
          minutes: 5
    
    action:
      - service: notify_manager.send_actionable
        data:
          title: "üí° Lichter noch an"
          message: "M√∂chtest du alle Lichter ausschalten?"
          priority: normal
          tag: lights_reminder
          actions:
            - action: "LIGHTS_OFF"
              title: "Alle aus"
            - action: "LIGHTS_KEEP"
              title: "Anlassen"
          data:
            # action_data wird bei Button-Klick zur√ºckgegeben (iOS)
            action_data:
              entity_id: "all"
              triggered_by: "presence_sensor"
      
      - wait_for_trigger:
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "LIGHTS_OFF"
        timeout:
          minutes: 10
        continue_on_timeout: false
      
      # Wenn Button geklickt wurde
      - service: light.turn_off
        target:
          entity_id: all


# =============================================================================
# SZENEN - Notify Manager mit Szenen verwenden
# =============================================================================

scene:
  # Szene die Benachrichtigung sendet wenn aktiviert
  - id: gute_nacht_mit_benachrichtigung
    name: "Gute Nacht (mit Benachrichtigung)"
    entities:
      light.wohnzimmer:
        state: "off"
      light.schlafzimmer:
        state: "on"
        brightness: 30
      cover.rolladen_schlafzimmer:
        state: "closed"
      input_boolean.nachtmodus:
        state: "on"

# Automation die nach Szenen-Aktivierung Benachrichtigung sendet
automation:
  - id: szene_gute_nacht_notification
    alias: "Szene - Gute Nacht Benachrichtigung"
    
    trigger:
      - platform: event
        event_type: call_service
        event_data:
          domain: scene
          service: turn_on
          service_data:
            entity_id: scene.gute_nacht_mit_benachrichtigung
    
    action:
      - service: notify_manager.send_notification
        data:
          title: "üåô Gute Nacht"
          message: >
            Gute Nacht Szene aktiviert.
            {% set lights_on = states.light | selectattr('state', 'eq', 'on') | list | count %}
            {{ lights_on }} Lichter sind noch an.
          category: info
          priority: low


# =============================================================================
# SCRIPT - Wiederverwendbare Benachrichtigungs-Logik
# =============================================================================

script:
  benachrichtigung_mit_bestaetigung:
    alias: "Benachrichtigung mit Best√§tigung"
    description: "Sendet Benachrichtigung und wartet auf Best√§tigung"
    mode: parallel
    
    fields:
      title:
        description: "Titel der Benachrichtigung"
        required: true
        example: "Wichtige Nachricht"
      message:
        description: "Nachricht"
        required: true
        example: "Bitte best√§tigen"
      confirm_action:
        description: "Aktion bei Best√§tigung"
        required: false
        example: "light.turn_off"
      target_entity:
        description: "Ziel-Entity f√ºr die Aktion"
        required: false
        example: "light.wohnzimmer"
    
    sequence:
      - variables:
          action_yes: "{{ 'CONFIRM_YES_' ~ context.id }}"
          action_no: "{{ 'CONFIRM_NO_' ~ context.id }}"
      
      - service: notify_manager.send_actionable
        data:
          title: "{{ title }}"
          message: "{{ message }}"
          priority: high
          actions:
            - action: "{{ action_yes }}"
              title: "‚úì Ja"
            - action: "{{ action_no }}"
              title: "‚úó Nein"
      
      - wait_for_trigger:
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_yes }}"
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_no }}"
        timeout:
          minutes: 5
      
      - if:
          - condition: template
            value_template: "{{ wait.trigger.event.data.action == action_yes and confirm_action is defined }}"
        then:
          - service: "{{ confirm_action }}"
            target:
              entity_id: "{{ target_entity }}"

  # Script aufrufen
  # service: script.benachrichtigung_mit_bestaetigung
  # data:
  #   title: "Licht ausschalten?"
  #   message: "Soll das Licht im Wohnzimmer ausgeschaltet werden?"
  #   confirm_action: "light.turn_off"
  #   target_entity: "light.wohnzimmer"
